//
//  ExamSyncHelper.swift
//  Electsys Utility
//
//  Created by yuxiqian on 2018/9/6.
//  Copyright © 2018 yuxiqian. All rights reserved.
//

import Foundation
import Alamofire

let examRequestUrl = "http://electsys.sjtu.edu.cn/edu/student/examArrange/examArrange.aspx"


class ExamSync {
    
    var delegate: examQueryDelegate?
    
    func getExamData(year: Year, term: Term) {
        let postParams: Parameters = [
            "__VIEWSTATE": "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",
            "__VIEWSTATEGENERATOR": "34BBCD78",
            "__EVENTVALIDATION": "/wEWFwKPgurxDwKIm9TqAgKJm/jIDQKOm7z3DAKPm4C3DQKMm8T3DwKNm6i3DAKSm+z3DgKTm/C3DwKQm7T2CQLK2bOYDwLF2dujAQLC2bfaAQLL2aPAAgLI2d9aAsnZy8ANAsbZ59oDAs/Zk88MAszZj9kCAs3Zu88PAtGfsbYPAtCfsbYPAu+OvL8FSJkkx898NnwTgP7A5KF1W3Aytl4=",
            "dpXn": ConvertToString(year),
            "dpXq": String(term.rawValue),
            "btnQuery": "查 询"
        ]
        Alamofire.request(examRequestUrl, method: .post, parameters: postParams, encoding: URLEncoding.httpBody).responseData(completionHandler: { response in
            self.delegate?.parseResponse(examData: String(data: response.data!, encoding: .utf8)!)
        })
    }
}
